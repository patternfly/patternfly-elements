# This workflow will build and run the test suite
# on all opened and updated (and labeled) PRs where
# at least one file does not match paths-ignore.
name: Build & test

on:
  # Build when a PR
  pull_request:
    types:
      - opened
      - synchronize
      - labeled
      - ready_for_review
    # TODO: build is required for merging so we can't ignore these
    # Will only run if files other than these are edited
    # paths-ignore:
    #   - ".github/ISSUE_TEMPLATE/**"
    #   - ".github/PULL_REQUEST_TEMPLATE/**"
    #   - ".storybook/**"
    #   - "docs/**"
    #   - "generators/**"
    #   - "**/*.md"
    #   - "**/*.text"
    #   - "*.md"
  # Build when PRs are merged into master/main
  push:
    branches: [master, main]
  # Manual run, no inputs necessary
  workflow_dispatch:

env:
  FORCE_COLOR: true
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # For webdriver script
  BROWSERSTACK_USER: ${{ secrets.BROWSERSTACK_USER }}
  BROWSERSTACK_KEY: ${{ secrets.BROWSERSTACK_KEY }}

  # https://github.blog/changelog/2020-10-01-github-actions-deprecating-set-env-and-add-path-commands/
  ACTIONS_ALLOW_UNSECURE_COMMANDS: "true"

  GITHUB_CONTEXT: ${{ toJson(github) }}

jobs:
  # Turn this on to debug an action
  # debug:
  #   name: Debug
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Debugging context variables
  #       run: echo "$GITHUB_CONTEXT"
  build:
    name: Compile project
    outputs:
      CACHE_KEY: ${{ steps.hash.outputs.HASH }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node: ['12.x']
    # Confirm that the PR is not in draft
    if: |
      (
        github.event_name == 'pull_request' &&
        github.event.action == 'labeled' &&
        (github.event.label.name == 'run e2e' || github.event.label.name == 'ready to merge')
      ) ||
      (
        github.event_name == 'pull_request' &&
        github.event.action != 'labeled' &&
        github.event.pull_request.draft == false &&
        !contains(github.event.pull_request.labels.*.name, 'blocked') &&
        !contains(github.event.pull_request.labels.*.name, 'skip ci')
      ) ||
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'push'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Capture hash value
        id: hash
        run: echo '::set-output name=HASH::${{ runner.os }}-npm-${{ matrix.node }}-${{ hashFiles('**/package-lock.json') }}'

      # Configures the node version used on GitHub-hosted runners
      - name: Configure node version
        uses: actions/setup-node@v1
        with:
          node-version: ${{ matrix.node }}

      # Caching speeds up the npm install step
      - name: Cache node modules
        id: cache
        uses: actions/cache@v2
        with:
          # npm cache files are stored in `~/.npm` on Linux/macOS
          path: |
            ~/.npm
            **/node_modules
            ~/.cache/ms-playwright
          key: ${{ steps.hash.outputs.HASH }}

      - name: Install dependencies
        if: steps.cache.outputs.cache-hit != 'true'
        run: npm ci
        # TODO: looking into how to to automatically update package-lock if ci fails
        # run: npm ci || npm install

      # - name: Update package-lock if necessary
      #   run: |
      #     git add package-lock.json
      #     git config user.name github-actions
      #     git config user.email github-actions@github.com
      #     git commit -m "Auto update package-lock during `Build & test` action due to npm ci failure"
      #     git push origin ${{ github.head_ref }}
          
      - name: Build
        id: build
        run: npm run build

      # Upload compiled assets to make them available for downstream jobs
      - name: Upload artifacts
        uses: actions/upload-artifact@v2
        with:
          name: compiled-assets
          path: elements/*/dist/*
          if-no-files-found: error

  # Test command can run concurrent with e2e and test-wtr so it downloads the
  # compiled assets from the build and uses those instead of reinstalling.
  test:
    name: Run test suite (Web Component Tester)
    needs: build
    runs-on: ubuntu-latest
    if: needs.build.result == 'success'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      # Configures the node version used on GitHub-hosted runners
      - name: Configure node version
        uses: actions/setup-node@v1
        with:
          node-version: ${{ matrix.node }}

      # Caching speeds up the npm install step
      - name: Access cached node modules
        id: get-node-cache
        uses: actions/cache@v2
        with:
          # npm cache files are stored in `~/.npm` on Linux/macOS
          path: |
            ~/.npm
            **/node_modules
          key: ${{ needs.build.outputs.CACHE_KEY }}

      - name: Install dependencies
        if: steps.get-node-cache.outputs.cache-hit != 'true'
        run: npm ci

      - name: Access compiled assets
        uses: actions/download-artifact@v2
        id: download-compiled-assets
        with:
          name: compiled-assets
          path: elements

      - name: Build
        if: failure()
        run: npm run build

      - name: Run tests
        run: npm test -- --nobuild

  # Test command can run concurrent with e2e and wct so it downloads the
  # compiled assets from the build and uses those instead of reinstalling.
  test-wtr:
    name: Run test suite (Web Test Runner)
    needs: build
    runs-on: ubuntu-latest
    if: needs.build.result == 'success'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      # Configures the node version used on GitHub-hosted runners.
      - name: Configure node version
        uses: actions/setup-node@v1
        with:
          node-version: ${{ matrix.node }}

      # Set up cross-browser testing on Chromium, WebKit and Firefox with Playwright.
      - name: Set up Playwright
        uses: microsoft/playwright-github-action@v1

      # Caching speeds up the npm install step.
      - name: Access cached node modules
        id: get-node-cache
        uses: actions/cache@v2
        with:
          # npm cache files are stored in `~/.npm` on Linux/macOS
          path: |
            ~/.npm
            **/node_modules
            ~/.cache/ms-playwright
          key: ${{ needs.build.outputs.CACHE_KEY }}

      - name: Install dependencies
        if: steps.get-node-cache.outputs.cache-hit != 'true'
        run: npm ci

      - name: Access compiled assets
        uses: actions/download-artifact@v2
        id: download-compiled-assets
        with:
          name: compiled-assets
          path: elements

      - name: Retry build if it failed
        if: failure()
        run: npm run build

      - name: Run tests
        run: npm run test:ci

  # E2E command can run concurrent with test so it downloads the
  # compiled assets from the build and uses those instead of reinstalling.
  # Only run visual tests if the PR is labeled "ready to merge" or "run e2e"
  e2e:
    name: Visual regression testing
    needs: build
    if: needs.build.result == 'success' && (
        contains(github.event.pull_request.labels.*.name, 'ready to merge') ||
        contains(github.event.pull_request.labels.*.name, 'run e2e') ||
        contains(github.event.pull_request.user.login, 'dependabot')
      ) && !contains(github.event.pull_request.labels.*.name, 'skip vrt')
    runs-on: ubuntu-latest
    steps:
      - name: BrowserStack environment setup
        uses: "browserstack/github-actions/setup-env@master"
        with:
          username: ${{ secrets.BROWSERSTACK_USER }}
          access-key: ${{ secrets.BROWSERSTACK_KEY }}

      - name: Start BrowserStackLocal
        uses: browserstack/github-actions/setup-local@master
        with:
          local-testing: start
          local-identifier: random
          # local-logging-level: all-logs

      - name: Checkout repository
        uses: actions/checkout@v2

      # Configures the node version used on GitHub-hosted runners
      - name: Configure node version
        uses: actions/setup-node@v1
        with:
          node-version: ${{ matrix.node }}

      # Caching speeds up the npm install step
      - name: Access cached node modules
        id: get-node-cache
        uses: actions/cache@v2
        with:
          # npm cache files are stored in `~/.npm` on Linux/macOS
          path: |
            ~/.npm
            **/node_modules
          key: ${{ needs.build.outputs.CACHE_KEY }}

      - name: Install dependencies
        if: steps.get-node-cache.outputs.cache-hit != 'true'
        run: npm ci

      - name: Access compiled assets
        uses: actions/download-artifact@v2
        id: download-compiled-assets
        with:
          name: compiled-assets
          path: elements

      - name: Build
        if: failure()
        run: npm run build

      - name: Visual regression tests
        id: vrt
        run: npm run e2e -- --verbose

      # Upload assets even if the e2e fails
      - name: Archive baseline images
        if: success() || failure()
        uses: actions/upload-artifact@v2
        with:
          name: visual-regression-snapshots
          path: |
            .tmp/
            test/vrt-baseline
            test/vrt-snapshots
          if-no-files-found: error

      - name: Stop BrowserStackLocal
        if: always()
        uses: browserstack/github-actions/setup-local@master
        with:
          local-testing: stop

      # Report on the results of the visual regression tests
      # only if this is a pull request & the tests weren't skipped
      # This will return pass or fail based on results + labels and can
      # be used as a required test to ensure passing visual tests when needed
      # https://github.com/marketplace/actions/test-reporter
      - name: Report on results
        if: always()
        uses: dorny/test-reporter@v1
        with:
          # Name of the Check Run which will be created
          name: 'Test report'
          # Coma separated list of paths to test results
          path: 'test/vrt-results/vrt-results.json'
          # Format of test results
          reporter: 'mocha-json'
          # Limits which test suites are listed
          list-suites: 'failed'
          # Limits which test cases are listed
          list-tests: 'failed'
          # Limits number of created annotations with error message and stack trace captured during test execution.
          # Must be less or equal to 50.
          max-annotations: '50'
          # Set action as failed if test report contains any failed test
          fail-on-error: 'false'
          # Personal access token used to interact with Github API
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Return success if passed or intentionally skipped
        if: |
          steps.vrt.outputs.exit_code == 0 || 
          contains(github.event.pull_request.labels.*.name, 'skip vrt') || 
          contains(github.event.pull_request.labels.*.name, 'skip e2e')
        run: exit 0

      - name: Return failure if failed and not skipped
        if: |
          steps.vrt.outputs.exit_code == 1 && 
          !contains(github.event.pull_request.labels.*.name, 'skip vrt') && 
          !contains(github.event.pull_request.labels.*.name, 'skip e2e')
        run: exit 1
        
  # Validate the build to master was successful; open an issue if not
  validate:
    name: Validate successful build on master
    needs: [build, test, test-wtr, e2e]
    if: |
      always() &&
      github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Open issue if build breaks
        if: needs.build.outcome == 'failure'
        uses: imjohnbo/issue-bot@v3
        with:
          assignees: "castastrophe"
          labels: "fix, priority: high"
          pinned: true
          project: 2  # The project-number from organization project
          column: Prioritized
          close-previous: true
          title: "‚ùå Build is failing on master"
          body: "It looks like the build is currently failing on the master branch. See failed [action results](https://github.com/patternfly/patternfly-elements/actions/runs/${{ github.run_id }}) for more details."
      - name: Open issue if tests fail
        if: |
          needs.test.outcome == 'failure' ||
          needs.test-wtr.outcome == 'failure' ||
          needs.e2e.outcome == 'failure'
        uses: imjohnbo/issue-bot@v3
        with:
          assignees: "castastrophe"
          labels: "fix, priority: medium"
          pinned: true
          project: 2  # The project-number from organization project
          column: Prioritized
          close-previous: true
          title: "üß™ Tests are failing on master"
          body: "It looks like the build is currently failing on the master branch. See failed [action results](https://github.com/patternfly/patternfly-elements/actions/runs/${{ github.run_id }}) for more details."
